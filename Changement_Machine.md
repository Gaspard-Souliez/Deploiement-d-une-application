---
title: Procédure sur le changement de machine physique   
author: Arthur KELLER, Gaspard SOULIEZ
header-includes: 
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead{}
  - \fancyhead[C]{SAE3.03 - Déploiement d'une application}
  - \fancyhead[R]{\thepage}
  - \fancyfoot{}
  - \fancyfoot[C]{\thepage}
  - \renewcommand{\headrulewidth}{0.4pt}
  - \renewcommand{\footrulewidth}{0pt}
---
\newpage

# Changement de machine physique

## Arreter Synapse
Pour arrêter Synapse, il vous suffit de copier coller cette commande :
```bash
user@matrix$ sudo systemctl stop matrix-synapse
```

Puis pour verifier que le serveur est bien arreter en tapant cette commande:
```bash
user@matrix$ sudo systemctl status matrix-synapse
```

Normalement la commande devrez vous renvoyer ceci :
```bash
○ matrix-synapse.service - Synapse Matrix homeserver
     Loaded: loaded (/lib/systemd/system/matrix-synapse.service; enabled; preset: enabled)
     Active: inactive (dead) since Mon 2023-12-18 13:48:11 CET; 4min 54s ago
    Process: 481 ExecStartPre=/opt/venvs/matrix-synapse/bin/python -m synapse.app.homeserver --config-path=/etc/matrix-synapse/homeserver.yaml --config-path=/etc/matrix-synapse/conf.d/ --generate-keys (code=exited, status=0/SUCCESS)
    Process: 522 ExecStart=/opt/venvs/matrix-synapse/bin/python -m synapse.app.homeserver --config-path=/etc/matrix-synapse/homeserver.yaml --config-path=/etc/matrix-synapse/conf.d/ (code=exited, status=0/SUCCESS)
   Main PID: 522 (code=exited, status=0/SUCCESS)
        CPU: 3.392s

déc. 18 14:47:40 matrix systemd[1]: Starting matrix-synapse.service - Synapse Matrix homeserver...
déc. 18 14:47:44 matrix systemd[1]: Started matrix-synapse.service - Synapse Matrix homeserver.
déc. 18 13:48:11 matrix systemd[1]: Stopping matrix-synapse.service - Synapse Matrix homeserver...
déc. 18 13:48:11 matrix systemd[1]: matrix-synapse.service: Deactivated successfully.
déc. 18 13:48:11 matrix systemd[1]: Stopped matrix-synapse.service - Synapse Matrix homeserver.
déc. 18 13:48:11 matrix systemd[1]: matrix-synapse.service: Consumed 3.392s CPU time.
```

## Modification du fichier serveur_name.yml
Maintenant il va falloir changer le nom du serveur
Pour ce faire, il vous suffit de taper la commande
```bash
user@matrix$ sudo nano /etc/matrix-synapse/conf.d/server_name.yaml
```

Puis modifier le 
```bash
server_name: <nom du serveur>:8008
```
par
```bash
server_name: <le nom du serveur souhaité>:8008
```

Vous devrez avoir un fichier qui ressemeble à celui-ci:
```bash
# This file is autogenerated, and will be recreated on upgrade if it is deleted.
# Any changes you make will be preserved.

# The domain name of the server, with optional explicit port.
# This is used by remote servers to connect to this server,
# e.g. matrix.org, localhost:8080, etc.
# This is also the last part of your UserID.
#
server_name: <Le nom que vous lui avez donné>:8008
```

## Détruire et recréer la base de donnée
### Détruire la base de donnée
Ensuite vous devrez detruire la base de donnée
Pour ce faire, vous avez juste à taper ces commandes: 
```bash
# Se connecter à l'utilisateur postgres
user@matrix$ sudo su -l postgres 
```

Une fois connecter, vous pouvez verifier que vous avez bien la base de donnée `matrix` de créer. 
```bash
postgres@matrix$ psql -l 
```

Normalement vous devez avoir quelque similaire à ceci :
```bash
                                                    Liste des bases de données
    Nom    | Propriétaire | Encodage | Collationnement | Type caract. | Locale ICU | Fournisseur de locale |    Droits d'accès     
-----------+--------------+----------+-----------------+--------------+------------+-----------------------+-----------------------
 matrix    | matrix       | UTF8     | C               | C            |            | libc                  | 
 postgres  | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | 
 template0 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
 template1 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
(4 lignes)
```
Si ce n'est pas la cas, ce n'est pas grave vous pouvez passer directement à l'étape suivante.

Pour supprimer la base de donnée `matrix`, vous devez taper cette ligne :
```bash
postgres@matrix$ dropdb matrix
```

Puis verifier que la base de donnée à bien été supprimer avec la commande juste au dessus. Vous devez avoir quelque similaire à ceci :
```bash
                                                    Liste des bases de données
    Nom    | Propriétaire | Encodage | Collationnement | Type caract. | Locale ICU | Fournisseur de locale |    Droits d'accès     
-----------+--------------+----------+-----------------+--------------+------------+-----------------------+-----------------------
 postgres  | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | 
 template0 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
 template1 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
(4 lignes)
```

### Recréer la base de donnée
Pour recréer la base de donnée, vous avez juste à taper cette commande :
```bash
postgres@matrix:~$ createdb --encoding=UTF8 --locale=C --template=template0 --owner=matrix matrix
```

Puis verifier que celle ci à bien été créée avec la commande suivante :
```bash
postgres@matrix:~$ psql -l
```
Et vous devrez avoir quelque chose de similaire à ceci :
```bash
                                                    Liste des bases de données
    Nom    | Propriétaire | Encodage | Collationnement | Type caract. | Locale ICU | Fournisseur de locale |    Droits d'accès     
-----------+--------------+----------+-----------------+--------------+------------+-----------------------+-----------------------
 matrix    | matrix       | UTF8     | C               | C            |            | libc                  | 
 postgres  | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | 
 template0 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
 template1 | postgres     | UTF8     | fr_FR.UTF-8     | fr_FR.UTF-8  |            | libc                  | =c/postgres          +
           |              |          |                 |              |            |                       | postgres=CTc/postgres
(4 lignes)
```

## Redemarrer votre serveur
Pour cela, vous devez taper la commande suivante 
```bash
user@matrix$ sudo systemctl start matrix-synapse
```
Puis pour verifier si celui-ci est bien démarrer, taper la commande :
```bash
user@matrix$ sudo systemctl status matrix-synapse
```
Normalement, vous devez avoir quelque chose de similaire à ceci:
```bash
Mettre un exemple
```

## Recréer les utilisateurs
Pour créer un utilisateur Synapse, vous avez juste à taper la commande :
```bash
user@matrix$ sudo register_new_matrix_user -k <La clé que vous avez mise dans votre fichier de configuration>
```
=======
Pour cela, vous devez juste

